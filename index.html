<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>Mapa de Alarmes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; min-height:600px; border-radius:12px; overflow:hidden; }

    .blinking-icon {
      background: red; border-radius: 50%;
      width: 18px; height: 18px; display: block;
      box-shadow: 0 0 8px rgba(255,0,0,0.8);
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }
    .normal-icon {
      background: #2ecc71; border-radius: 50%;
      width: 14px; height: 14px; display: block;
      box-shadow: 0 0 5px rgba(46,204,113,0.7);
    }
    .popup-card { font-size: 13px; }

    .chip {
      display: inline-block; margin: 4px 4px; padding: 4px 8px;
      border-radius: 12px; font-size: 12px; cursor: pointer; font-weight: bold;
    }
    .chip:hover { opacity: 0.8; }
    .chip.active { background: #e74c3c; color: #fff; }
    .chip.normal { background: #27ae60; color: #fff; }
    .chip.critica { background: #8e44ad; color: #fff; }
    .chip.alta { background: #d35400; color: #fff; }
    .chip.media { background: #2980b9; color: #fff; }
    .chip.baixa { background: #16a085; color: #fff; }

    .summary-box {
      background: rgba(255,255,255,0.95); padding: 8px;
      border-radius: 8px; font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      max-width: 220px;
    }
    .summary-section { margin-bottom: 6px; }
    .summary-section h4 {
      margin: 0 0 4px; font-size: 13px;
      border-bottom: 1px solid #ddd; padding-bottom: 2px; color: #444;
    }
    .city-list {
      font-size: 11px; margin: 2px 0 6px 0; padding-left: 8px;
      color: #333; display: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const map = L.map("map").setView([-15.78, -47.93], 4);
    L.tileLayer("https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png", {
      attribution: "&copy; OSM & CARTO",
      subdomains: "abcd",
      maxZoom: 19
    }).addTo(map);

    // ðŸ”¹ MOCK de alarmes
    const alarmes = [
      { Cidade: "SÃ£o Paulo", Estado: "SP", Latitude: -23.5505, Longitude: -46.6333, Regional: "Sudeste", alarm_name: "Falha de energia", alarm_severity: "Alta", alarm_group: "Infraestrutura", alarm_active: 1 },
      { Cidade: "Rio de Janeiro", Estado: "RJ", Latitude: -22.9068, Longitude: -43.1729, Regional: "Sudeste", alarm_name: "LatÃªncia alta", alarm_severity: "MÃ©dia", alarm_group: "Rede", alarm_active: 0 },
      { Cidade: "Belo Horizonte", Estado: "MG", Latitude: -19.9167, Longitude: -43.9345, Regional: "Sudeste", alarm_name: "Perda de conexÃ£o", alarm_severity: "CrÃ­tica", alarm_group: "Rede", alarm_active: 1 },
      { Cidade: "BrasÃ­lia", Estado: "DF", Latitude: -15.7939, Longitude: -47.8828, Regional: "Centro-Oeste", alarm_name: "Instabilidade", alarm_severity: "Baixa", alarm_group: "AplicaÃ§Ã£o", alarm_active: 0 },
      { Cidade: "Salvador", Estado: "BA", Latitude: -12.9777, Longitude: -38.5016, Regional: "Nordeste", alarm_name: "Falha no link", alarm_severity: "Alta", alarm_group: "Rede", alarm_active: 1 }
    ];

    const markers = [];
    const grupos = { ativos: [], normais: [], critica: [], alta: [], media: [], baixa: [] };

    alarmes.forEach(d => {
      const ativo = d.alarm_active == 1;
      const icon = L.divIcon({
        className: "",
        html: `<span class="${ativo ? "blinking-icon" : "normal-icon"}"></span>`,
        iconSize: [20, 20]
      });
      const marker = L.marker([d.Latitude, d.Longitude], { icon }).addTo(map);

      marker.bindPopup(`
        <div class="popup-card">
          <h3>${d.Cidade}/${d.Estado}</h3>
          <b>Status:</b> ${ativo ? "ðŸš¨ Ativo" : "âœ… Normal"}<br>
          <b>Alarme:</b> ${d.alarm_name}<br>
          <b>Severidade:</b> ${d.alarm_severity}<br>
          <b>Grupo:</b> ${d.alarm_group}<br>
          <b>RegiÃ£o:</b> ${d.Regional}
        </div>
      `);

      markers.push(marker);

      if (ativo) grupos.ativos.push({ marker, label: `${d.Cidade}/${d.Estado}` });
      else grupos.normais.push({ marker, label: `${d.Cidade}/${d.Estado}` });

      const sev = d.alarm_severity.toLowerCase();
      if (sev.includes("crÃ­tic")) grupos.critica.push({ marker, label: `${d.Cidade}/${d.Estado}` });
      if (sev.includes("alta")) grupos.alta.push({ marker, label: `${d.Cidade}/${d.Estado}` });
      if (sev.includes("mÃ©dia")) grupos.media.push({ marker, label: `${d.Cidade}/${d.Estado}` });
      if (sev.includes("baixa")) grupos.baixa.push({ marker, label: `${d.Cidade}/${d.Estado}` });
    });

    if (markers.length > 0) {
      const group = L.featureGroup(markers.map(m => m)).getBounds();
      map.fitBounds(group);
    }

    // ðŸ”¹ Resumo em chips (separados)
    const resumoControl = L.control({ position: "topright" });
    resumoControl.onAdd = function() {
      const div = L.DomUtil.create("div", "summary-box");
      div.innerHTML = `
        <div class="summary-section">
          <h4>Status Operacional</h4>
          <div class="chip active">Ativos: ${grupos.ativos.length}</div>
          <div class="city-list" id="ativos-list"></div>
          <div class="chip normal">Normais: ${grupos.normais.length}</div>
          <div class="city-list" id="normais-list"></div>
        </div>
        <div class="summary-section">
          <h4>Severidades</h4>
          <div class="chip critica">CrÃ­tica: ${grupos.critica.length}</div>
          <div class="city-list" id="critica-list"></div>
          <div class="chip alta">Alta: ${grupos.alta.length}</div>
          <div class="city-list" id="alta-list"></div>
          <div class="chip media">MÃ©dia: ${grupos.media.length}</div>
          <div class="city-list" id="media-list"></div>
          <div class="chip baixa">Baixa: ${grupos.baixa.length}</div>
          <div class="city-list" id="baixa-list"></div>
        </div>
      `;
      return div;
    };
    resumoControl.addTo(map);

    // ðŸ”¹ Interatividade chips
    setTimeout(() => {
      document.querySelectorAll(".chip").forEach(chip => {
        const type = chip.classList[1]; // active, normal, critica, etc
        const group = grupos[type];

        chip.addEventListener("mouseenter", () => {
          const listDiv = document.getElementById(`${type}-list`);
          if (listDiv && group) {
            listDiv.style.display = "block";
            listDiv.innerHTML = group.map(g => `â€¢ ${g.label}`).join("<br>");
          }
        });

        chip.addEventListener("mouseleave", () => {
          const listDiv = document.getElementById(`${type}-list`);
          if (listDiv) listDiv.style.display = "none";
        });

        chip.addEventListener("click", () => {
          if (group && group.length > 0) {
            const fg = L.featureGroup(group.map(g => g.marker));
            map.fitBounds(fg.getBounds(), { maxZoom: 10 });
            markers.forEach(m => m.getElement().style.opacity = 0.3);
            group.forEach(g => g.marker.getElement().style.opacity = 1);
          }
        });
      });

      // resetar filtro ao clicar no mapa
      map.on("click", () => {
        markers.forEach(m => m.getElement().style.opacity = 1);
      });
    }, 500);
  </script>
</body>
</html>
