<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>Mapa de Alarmes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- PapaParse para ler CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; min-height:600px; border-radius:12px; overflow:hidden; }

    .blinking-icon {
      background: red; border-radius: 50%;
      width: 18px; height: 18px; display: block;
      box-shadow: 0 0 8px rgba(255,0,0,0.8);
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }
    .normal-icon {
      background: #2ecc71; border-radius: 50%;
      width: 14px; height: 14px; display: block;
      box-shadow: 0 0 5px rgba(46,204,113,0.7);
    }
    .popup-card { font-size: 13px; }

    .chip {
      display: block; margin: 4px 0; padding: 6px 10px;
      border-radius: 12px; font-size: 13px; cursor: pointer; font-weight: bold;
    }
    .chip:hover { opacity: 0.8; }
    .chip.active { background: #e74c3c; color: #fff; }
    .chip.normal { background: #27ae60; color: #fff; }
    .chip.critica { background: #c0392b; color: #fff; }
    .chip.alta { background: #d35400; color: #fff; }
    .chip.media { background: #2980b9; color: #fff; }
    .chip.warning { background: #f1c40f; color: #000; }
    .chip.info { background: #16a085; color: #fff; }

    .summary-box {
      background: rgba(255,255,255,0.95); padding: 10px;
      border-radius: 10px; font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      max-width: 250px;
    }
    .summary-section h4 {
      margin: 6px 0; font-size: 14px;
      border-bottom: 1px solid #ddd; padding-bottom: 4px; color: #444;
    }
    .city-list {
      font-size: 12px; margin: 2px 0 6px 0; padding-left: 12px;
      color: #333; display: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const map = L.map("map").setView([-15.78, -47.93], 4);
    L.tileLayer("https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png", {
      attribution: "&copy; OSM & CARTO",
      subdomains: "abcd",
      maxZoom: 19
    }).addTo(map);

    const markers = [];
    const grupos = { ativos: [], normais: [], critica: [], alta: [], media: [], warning: [], info: [] };

    // ðŸ”¹ Carregar dados reais do CSV
    Papa.parse("eletro.csv", {
      download: true,
      header: true,
      complete: function(results) {
        const dados = results.data;

        dados.forEach(d => {
          if (!d.Latitude || !d.Longitude) return;

          const ativo = d.alarm_active == "1";
          const icon = L.divIcon({
            className: "",
            html: `<span class="${ativo ? "blinking-icon" : "normal-icon"}"></span>`,
            iconSize: [20, 20]
          });
          const marker = L.marker([parseFloat(d.Latitude), parseFloat(d.Longitude)], { icon }).addTo(map);

          marker.bindPopup(`
            <div class="popup-card">
              <h3>${d.Cidade || "N/A"}/${d.Estado || ""}</h3>
              <b>Status:</b> ${ativo ? "ðŸš¨ Ativo" : "âœ… Normal"}<br>
              <b>Alarme:</b> ${d.alarm_name || "N/A"}<br>
              <b>Severidade:</b> ${d.alarm_severity || "N/A"}<br>
              <b>Grupo:</b> ${d.alarm_group || "N/A"}<br>
              <b>RegiÃ£o:</b> ${d.Regional || "N/A"}
            </div>
          `);

          markers.push(marker);

          if (ativo) grupos.ativos.push({ marker, label: `${d.Cidade}/${d.Estado}` });
          else grupos.normais.push({ marker, label: `${d.Cidade}/${d.Estado}` });

          // ðŸ”¹ Normalizar severidades
          const sev = (d.alarm_severity || "").toUpperCase().trim();
          if (sev === "CRITICAL") grupos.critica.push({ marker, label: `${d.Cidade}/${d.Estado}` });
          if (sev === "MAJOR") grupos.alta.push({ marker, label: `${d.Cidade}/${d.Estado}` });
          if (sev === "MINOR") grupos.media.push({ marker, label: `${d.Cidade}/${d.Estado}` });
          if (sev === "WARNING") grupos.warning.push({ marker, label: `${d.Cidade}/${d.Estado}` });
          if (sev === "INFO") grupos.info.push({ marker, label: `${d.Cidade}/${d.Estado}` });
        });

        if (markers.length > 0) {
          const group = L.featureGroup(markers).getBounds();
          map.fitBounds(group);
        }

        // ðŸ”¹ Resumo interativo
        const resumoControl = L.control({ position: "topright" });
        resumoControl.onAdd = function() {
          const div = L.DomUtil.create("div", "summary-box");
          div.innerHTML = `
            <div class="summary-section">
              <h4>Status Operacional</h4>
              <div class="chip active">Ativos: ${grupos.ativos.length}</div>
              <div class="city-list" id="ativos-list"></div>
              <div class="chip normal">Normais: ${grupos.normais.length}</div>
              <div class="city-list" id="normais-list"></div>
            </div>
            <div class="summary-section">
              <h4>Severidades</h4>
              <div class="chip critica">CrÃ­tica: ${grupos.critica.length}</div>
              <div class="city-list" id="critica-list"></div>
              <div class="chip alta">Alta: ${grupos.alta.length}</div>
              <div class="city-list" id="alta-list"></div>
              <div class="chip media">MÃ©dia: ${grupos.media.length}</div>
              <div class="city-list" id="media-list"></div>
              <div class="chip warning">Aviso: ${grupos.warning.length}</div>
              <div class="city-list" id="warning-list"></div>
              <div class="chip info">Informativo: ${grupos.info.length}</div>
              <div class="city-list" id="info-list"></div>
            </div>
          `;
          return div;
        };
        resumoControl.addTo(map);

        // ðŸ”¹ Interatividade
        setTimeout(() => {
          document.querySelectorAll(".chip").forEach(chip => {
            const type = chip.classList[1];
            const group = grupos[type];

            chip.addEventListener("mouseenter", () => {
              const listDiv = document.getElementById(`${type}-list`);
              if (listDiv && group) {
                listDiv.style.display = "block";
                listDiv.innerHTML = group.map(g => `â€¢ ${g.label}`).join("<br>");
              }
            });

            chip.addEventListener("mouseleave", () => {
              const listDiv = document.getElementById(`${type}-list`);
              if (listDiv) listDiv.style.display = "none";
            });

            chip.addEventListener("click", () => {
              if (group && group.length > 0) {
                const fg = L.featureGroup(group.map(g => g.marker));
                map.fitBounds(fg.getBounds(), { maxZoom: 10 });
                markers.forEach(m => m.getElement().style.opacity = 0.3);
                group.forEach(g => g.marker.getElement().style.opacity = 1);
              }
            });
          });

          map.on("click", () => {
            markers.forEach(m => m.getElement().style.opacity = 1);
          });
        }, 500);
      }
    });
  </script>
</body>
</html>
